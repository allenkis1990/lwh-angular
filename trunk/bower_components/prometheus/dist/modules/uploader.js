/**
 * prometheus - 普罗米修斯
 * @author 
 * @version v1.0.8
 * @link 
 * @license MIT
 */
define(["angular","webuploader"],function(e,i){"use strict";function o(e,o){var t={standard:"small",superBigFileSize:1610612736,smallFileStandard:10485760,chunkSize:52428800,CURRENT_HB_WU:null};return t.doSpecialLog=function(e,i){o.log("%c"+e,"color:"+i)},t.uploadComplete=function(e,i){t.CURRENT_HB_WU.trigger("uploadProgress",e,1),t.CURRENT_HB_WU.trigger("uploadComplete",e),t.CURRENT_HB_WU.trigger("uploadSuccess",e,i),t.CURRENT_HB_WU.trigger("uploadFinished",e)},t.checkIsBigFile=function(e){return e>=t.smallFileStandard},t.isIe=function(){return function(e){var i=e.match(/MSIE\s([\d\.]+)/)||e.match(/(?:trident)(?:.*rv:([\w.]+))?/i);return i&&parseFloat(i[1])}(navigator.userAgent)},t.registerBigFileUpload=function(o){t.md5CheckPath=o.md5CheckPath,t.blockMd5CheckPath=o.blockMd5CheckPath;var n=new i.Runtime.Html5.Md5({});i.Uploader.register({"before-send-file":"beforeSendFile","before-send":"beforeSend"},{beforeSendFile:function(r){var a=$.Deferred(),l=r.size;if(r.guid=i.Base.guid(),e(function(){r.liveStatus=1}),r.md5=n.md5String([r.lastModifiedDate.getTime(),r.name,r.size].join("-")),t.checkIsBigFile(l)&&!t.isIe()){t.doSpecialLog("文件大小超过10M,并且开始执行文件的第一次md5计算","red");var u=r.name;$.ajax({type:"post",url:t.md5CheckPath,data:{md5:r.md5,guid:r.guid,originalFileName:u,context:o.context,requestContext:o.requestContext},cache:!1,dataType:"json",success:function(e){e.exists?(t.doSpecialLog("服务器存在计算完成的文件的md5，不执行上传，实现秒传","red"),t.uploadComplete(r,e),t.CURRENT_HB_WU.skipFile(r),a.reject(),r.newPath=e.newPath):a.resolve()},error:function(){a.resolve()}})}else e(function(){r.liveStatus=2}),a.resolve();return $.when(a)},beforeSend:function(e){var i=$.Deferred();if(t.checkIsBigFile(e.file.size)&&!t.isIe()){e.file.chunkMd5=n.md5String([e.file.lastModifiedDate.getTime(),e.file.name,e.chunk,e.file.size].join("-"));var r=e.file.name,a={md5:e.file.md5,guid:e.file.guid,originalFileName:r,size:e.file.size,context:o.context,requestContext:o.requestContext},l=e.chunks,u=e.chunk;l>1?(a.chunks=l,a.chunk=u,a.chunkMd5=e.file.chunkMd5,a.chunkSize=e.blob.size,$.ajax({type:"post",url:t.blockMd5CheckPath,data:a,cache:!1,dataType:"json"}).then(function(e){e.exists?i.reject():i.resolve()},function(){i.resolve()})):i.resolve()}else i.resolve();return $.when(i)}})},t}function t(o,t,n,r,a,l){return{restrict:"AE",require:"?^ngModel",scope:{onProgress:"&",onSuccess:"&",onFileQueued:"&",onFileTypeDenied:"&",onUploadStart:"&",onUploadStop:"&",onSave:"&",multi:"=",returnIsArray:"@",standard:"@",sizeLimit:"@",accepts:"@",hbFileUploader:"=",params:"=?"},link:function(a,u,s,c){function d(i,o){var t=r(i[o]);return e.isFunction(t.assign)}function p(){return"big"===a.standard}function f(i){i=e.fromJson(i.raw),e.isArray(c.$viewValue)?c.$viewValue.push(i):e.isObject(c.$viewValue)?c.$setViewValue(i):a.multi?c.$viewValue.push(i):c.$setViewValue(i)}function g(e){return 1===e}if(!c)return!1;a.$on("$destroy",function(){c.$setViewValue(""),null!==o.CURRENT_HB_WU&&o.CURRENT_HB_WU.stop(!0),c.$setValidity("required",!1)}),a.multi&&!c.$modelValue&&!e.isArray(c.$modelValue)&&c.$setViewValue([]);var h=l.getResourceInfo();l.registered||o.registerBigFileUpload(h),l.registered=!0;var S=h.resourceServicePath,m=o.isIe();!o.isIe()&&p()&&(S=h.uploadBigFilePath);var U,v=o.chunkSize,_=e.extend({},{context:h.context,requestContext:h.requestContext},a.params),F=S+"?uploadSync=true",R={pick:{id:u.attr("id")?"#"+u.attr("id"):u,innerHTML:s.buttonText||"选择文件",multiple:!1},timeout:0,formData:_,compress:!1,fileSizeLimit:a.sizeLimit,auto:!a.multi,swf:"/bower_components/webuploader_fex/dist/Uploader.swf",server:F,threads:1};m?(o.doSpecialLog("当前模式为ie， flash专享模式","red"),R.runtimeOrder="flash"):p()&&(R.chunked=!0,R.chunkRetry=0,R.chunkSize=v),a.accepts&&(R.accept={title:"files",extensions:a.accepts}),U=i.create(R),U.on("uploadProgress",function(e,i){var o=100*i;100===o&&t(function(){e.liveStatus=3}),t(function(){e.progress=o.toFixed(2)}),a.onProgress&&a.onProgress({percentage:i})}),U.on("uploadSuccess",function(e,i){o.doSpecialLog("上传成功....","#449d44"),e.uploadSuccess=!0,!a.multi&&U.reset(),t(function(){e.liveStatus=4,e.newPath=i.newPath,e.fileId=i.fileId,e.raw=i._raw,e.uploadStatus=3,f(e),a.onSuccess&&a.onSuccess({file:e})})}),U.on("stopUpload",function(e){a.onUploadStart&&a.onUploadStop({file:e}),o.doSpecialLog("停止上传.....","#c9302c")}),U.on("uploadStart",function(e){o.doSpecialLog("开始上传.....","#286090"),a.onUploadStart&&a.onUploadStart({file:e}),t(function(){e.uploadBegin=!0,e.uploadStatus=1})}),U.on("uploadBeforeSend",function(e,i,t){if((o.checkIsBigFile(e.file.size)||p())&&!o.isIe()){var n=e.chunks,r=e.chunk;o.doSpecialLog("当前分片数"+e.chunks,"pink"),i.guid=e.file.guid,i.md5=e.file.md5,i.originalFileName=e.file.name,n>1&&(i.chunks=n,i.chunk=r,i.chunkMd5=e.file.chunkMd5,i.chunkSize=e.blob.size)}}),d(s,"hbFileUploader")&&(a.hbFileUploader={localFileQueue:[],name:"hbWebUploader",uploadOne:function(e){t(function(){o.CURRENT_HB_WU=U,o.CURRENT_HB_WU.upload(e),e.uploadStatus=1})},save:function(){o.CURRENT_HB_WU=U;var e=o.CURRENT_HB_WU.getFiles();return e.length<=0?(o.doSpecialLog("上传文件队列不能为空....","red"),!1):void o.CURRENT_HB_WU.upload()},removeOne:function(e,i){function t(){o.CURRENT_HB_WU=U,o.CURRENT_HB_WU.removeFile(e),a.hbFileUploader.localFileQueue.splice(i,1)}return g(e.liveStatus)?(o.doSpecialLog("文件正在md5校验不能从队列中删除....","red"),!1):2===e.liveStatus?(window.confirm("文件正在上传确定要从队列中删除?",function(){t()}),!1):void t()},reupload:function(e){o.CURRENT_HB_WU=U,o.CURRENT_HB_WU.retry(e)},stopAll:function(){o.CURRENT_HB_WU=U,o.CURRENT_HB_WU.stop(!0)},stopOne:function(e){return g(e.liveStatus)?(o.doSpecialLog("文件正在md5校验，请等待校验结束再进行暂停操作!","red"),!1):void t(function(){o.CURRENT_HB_WU=U,o.CURRENT_HB_WU.stop(e),e.uploadStatus=2})}}),U.on("fileQueued",function(t){var n=[];for(var r in a.params)n.push(r+"="+a.params[r]);U.option("server",F+"&"+n.join("&"));var l=o.isIe(),u=o.checkIsBigFile(t.size);return o.superBigFileSize<t.size&&l?(window.alert("想体验超爽超大文件上传，请用chrome或者firefox主流浏览器...."),!1):!u||a.standard&&"big"===a.standard||o.isIe()?"big"!==a.standard||u||o.isIe()?(t.guid=i.Base.guid(),t.queueId=s.queueid,t.formatSize=i.Base.formatSize(t.size),t.progress=0,t.uploadStatus=0,t.uploadBegin=!1,t.liveStatus=0,a.multi?a.$apply(function(){a.hbFileUploader&&a.hbFileUploader.localFileQueue&&e.isArray(a.hbFileUploader.localFileQueue)&&a.hbFileUploader.localFileQueue.push(t)}):a.hbFileUploader&&(a.hbFileUploader.selectFile=t),void(a.onFileQueued&&a.onFileQueued({file:t}))):(o.doSpecialLog("当前上传文件大小定义属于小文件，请配置规格standard为small模式或者不配置.....","red"),!1):(o.doSpecialLog("当前上传文件大小定义属于大文件，请配置规格standard为big模式.....","red"),!1)}),U.on("error",function(o){var t;switch(o){case"Q_TYPE_DENIED":var n=this.options.accept,r="请上传:",l="";e.forEach(n,function(e){l+=e.extensions}),r+=l+"的文件类型",t=r;break;case"Q_EXCEED_SIZE_LIMIT":t="文件不能超过"+i.Base.formatSize(a.sizeLimit)}s.onFileTypeDenied?a.onFileTypeDenied({$info:{errorMessage:t,errorType:o,accepts:l,uploader:this,instance:U}}):console.log(t)}),U.on("uploadError",function(e,i){t(function(){e.liveStatus=-1}),n.log("%c上传过程中出现错误"+i,"color:red")})}}}var n=e.module("hb.webUploader",[]).run(["uploaderService",function(e){e.doSpecialLog("当前分片每片"+i.Base.formatSize(e.chunkSize)+"起","darkblue"),e.doSpecialLog("注册分片上传以及秒传，断点续传功能....","pink")}]).provider("HB_WebUploader",[function(){var e={};this.setResourceSource=function(i){e.name=i},this.$get=["$rootScope",function(i){return{getResourceInfo:function(){return i[e.name||"$$userInfo"]}}}]}]);n.factory("uploaderService",o),o.$inject=["$timeout","$log"],n.directive("hbFileUploader",t),t.$inject=["uploaderService","$timeout","$log","$parse","$rootScope","HB_WebUploader"]});