/**
 * prometheus - 普罗米修斯
 * @author 
 * @version v1.0.8
 * @link 
 * @license MIT
 */
define(["webuploader","angular"],function(e,r,t){function n(e){throw new Error(e)}return["$timeout","$parse","appConfig",function(a,o,i){var u={};return u.flashUrl=u.flashUrl||"/bower_components/fex-webuploader/dist/Uploader.swf",i.resourceServicePath||n("please offer "+function(){var e="";return i.resourceServicePath||(e="resourceServicePath"),e}()),{require:"ngModel",restrict:"A",link:function(s,c,f,l){function p(e){e.width&&!e.height&&n("please offer scale.height"),!e.width&&e.height&&n("please offer scale.width")}function d(){if(!f.scale)return arguments[2];var e=o(f.scale),t=e(s);if(t){if(r.isArray(t)){for(var n=t.length,a=0;a<n;a++){var i=t[a];p(i),i.type="scale"}return JSON.stringify(t)}return p(t),t.type="scale",JSON.stringify([t])}return arguments[2]}function h(){i.resourceServicePath.indexOf("?")===-1&&(i.resourceServicePath+="?1=1");var e=!0,r=[i.resourceServicePath,"uploadSync="+e],t=d();return t&&r.push("needOperate="+t),r.join("&")}l||n("元素节点上面必须要有ngModel指定对象!");var v=h(),m=function(){var e=o(f.acceptFileType),t=e(s);if(t){if(r.isArray(t))return t.join(",");if(r.isString(t))return t}return arguments[2]}(),g=$.extend({},{disableGlobalDnd:!1,dnd:t,pick:{id:c||t,innerHTML:f.uploadbuttonname!=t&&""!=f.uploadbuttonname?f.uploadbuttonname:"选择文件",multiple:!1},formData:{context:i.context,requestContext:i.requestContext},accept:{title:"files",extensions:m||"jpg,jpeg,bmp,png"},compress:!1,auto:!0,swf:u.flashUrl,server:v,threads:3},f);a(function(){var t=e.create(g),n=t;n.on("uploadSuccess",function(e,t){if(f.queueContainerId){var o=f.queueContainerId,u=$("#"+o),s="IMG"===u[0].tagName,c=r.fromJson(t).newPath;u=s?u:u.find("img"),u.attr("src",i.resourceServicePath+c),u.show()}a(function(){if(f.valueArray){var e={ImageName:r.fromJson(t).fileName,ImagePath:r.fromJson(t).newPath};l.$viewValue.push(e)}else l.$setViewValue(r.fromJson(t))}),n.reset()}),n.on("beforeFileQueued",function(e){var r=e.ext.toLowerCase(),t=g.accept.extensions;if(t.indexOf(r)===-1)return alert("请上传"+g.accept.extensions+"格式的图片!"),!1});var o=s.$watch(f.scale,function(e,r){n.option("server",h())},!0);s.$on("$destroy",function(){o()})})}}}]});