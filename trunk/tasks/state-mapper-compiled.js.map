{"version":3,"sources":["state-mapper.js"],"names":[],"mappings":"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","file":"state-mapper-compiled.js","sourcesContent":["/**\r\n * Created by wengpengfei on 2016/8/25.\r\n */\r\n\r\nvar gulp = require('gulp'),\r\n    fs = require('fs'),\r\n    config = require('../things/config/config'),\r\n    path = require('path'),\r\n    File = require('vinyl'),\r\n    through2 = require('through2');\r\n\r\n\r\nvar fileMap = {};\r\n\r\n/**\r\n *\r\n * {\r\n *      center: {},\r\n *      portal: {},\r\n *\r\n * }\r\n *\r\n *\r\n *\r\n *\r\n *\r\n * @param path\r\n * @returns {boolean}\r\n */\r\n\r\ngulp.task('stateMapper', function () {\r\n\r\n    config.findSubDirectory('./app')\r\n        .forEach(function (item, index) {\r\n            fileMap[item] = {\r\n                files: []\r\n            };\r\n\r\n\r\n            if (item === 'admin') {\r\n                fileMap[item].modules = {};\r\n            }\r\n\r\n            if (item === 'portal') {\r\n                fileMap[item].modules = {};\r\n            }\r\n        });\r\n\r\n    // 生成center 下面的目录结构\r\n\r\n\r\n    config.findSubDirectory('./app/admin/modules')\r\n\r\n        .forEach(function (item, index) {\r\n            fileMap['admin']['modules'][item] = {\r\n                files: []\r\n            };\r\n        });\r\n\r\n    config.findSubDirectory('./app/portal')\r\n\r\n        .forEach(function (item, index) {\r\n            fileMap['portal']['modules'][item] = {\r\n                files: []\r\n            };\r\n        });\r\n\r\n    // 登陆和播放没有状态配置， 不生成stateMapper\r\n    //delete fileMap.login;\r\n    //delete fileMap.play;\r\n    //delete fileMap.workflow;\r\n\r\n    return gulp.src('./app/**/*-state.js')\r\n\r\n        .pipe(function () {\r\n            return through2.obj(function (file, hex, next) {\r\n\r\n                // 收集阶段\r\n                collect(file);\r\n\r\n                next()\r\n            }, function (next) {\r\n\r\n                // 将收集的信息分析， 生成文件流\r\n\r\n                var stream = this;\r\n\r\n                Object.keys(fileMap).forEach(function (dir, index) {\r\n                    var item = fileMap[dir];\r\n                    switch (dir) {\r\n                        case 'admin':\r\n                            makeOnlyOne(stream, dir, item, dir + '/js/common/stateMapper.js');\r\n                            if (item.modules) {\r\n                                makeWithSub(stream, dir, item, dir + '/modules/$$directory$$/js/common/stateMapper.js');\r\n                            }\r\n                            break;\r\n                        //case 'login':\r\n                        //case 'play':\r\n                            break;\r\n                        case 'portal':\r\n                            makeWithSub(stream, dir, item, dir + '/$$directory$$/js/common/stateMapper.js', './');\r\n                            break;\r\n                        default:\r\n                            makeOnlyOne(stream, dir, item, dir + '/js/common/stateMapper.js');\r\n                            break;\r\n                    }\r\n                });\r\n\r\n                next();\r\n            })\r\n        }())\r\n\r\n        .pipe(gulp.dest('./app'));\r\n\r\n});\r\n\r\nfunction center(dir, file, app) {\r\n    var filePath = path.relative('./app/' + app + '/', file.path);\r\n\r\n    if (/^js/.test(filePath)) {\r\n        fileMap[dir].files.push(file);\r\n    }\r\n\r\n    if (/^modules/.test(filePath)) {\r\n        var myDir = getPreDir('./app/' + app + '/modules/', file.path);\r\n        fileMap[dir]['modules'][myDir].files.push(file);\r\n    }\r\n}\r\n\r\nfunction portal(dir, file) {\r\n    var myDir = getPreDir('./app/portal/', file.path);\r\n    fileMap[dir]['modules'][myDir].files.push(file);\r\n}\r\n\r\nfunction normal(dir, file) {\r\n    fileMap[dir].files.push(file);\r\n}\r\n\r\nfunction getPreDir(base, pth) {\r\n    return path.relative(base, pth).split('\\\\')[0];\r\n}\r\n\r\nfunction collect(file) {\r\n    var dir = getPreDir('./app/', file.path);\r\n    switch (dir) {\r\n        case 'admin':\r\n            center(dir, file, 'admin');\r\n            break;\r\n        case 'portal':\r\n            portal(dir, file);\r\n            break;\r\n        //case 'login':\r\n        //case 'play':\r\n            //break;\r\n        default:\r\n            normal(dir, file);\r\n            break;\r\n    }\r\n}\r\n\r\nfunction makeWithSub(stream, dir, item, mapperPath, deep) {\r\n    Object.keys(item.modules)\r\n        .forEach(function (directory, index) {\r\n            var portalSubItem = item.modules[directory],\r\n                stateMapper = 'define(function() {\"use strict\"; return ',\r\n                mapper = {\r\n                    modules: [],\r\n                    futureStates: []\r\n                };\r\n            portalSubItem.files.forEach(function (subFile, subIndex) {\r\n                var dirPath = path.normalize(subFile.path).replace(/.*?\\\\js\\\\states\\\\/, '').replace(/\\.js$/, '');\r\n                var stateName = path.basename(subFile.path).replace(/(-state.js)$/, '');\r\n                module(mapper, dirPath, stateName, deep, dir + '\\\\', directory);\r\n                futureState(mapper, dirPath, stateName, deep, dir + '\\\\', directory);\r\n            });\r\n\r\n            stateMapper += (JSON.stringify(mapper) + '});');\r\n\r\n            stream.push(function () {\r\n                var file = new File();\r\n                file.path = mapperPath.replace('$$directory$$', directory);\r\n                file.contents = new Buffer(stateMapper);\r\n                return file\r\n            }())\r\n        });\r\n}\r\n\r\nfunction makeOnlyOne(stream, dir, item, mapperPath, deep) {\r\n    var stateMapper = 'define(function() {\"use strict\"; return ',\r\n        mapper = {\r\n            modules: [],\r\n            futureStates: []\r\n        };\r\n\r\n    item.files.forEach(function (subFile, subIndex) {\r\n        var dirPath = path.normalize(subFile.path).replace(/.*?\\\\js\\\\states\\\\/, '').replace(/\\.js$/, '');\r\n        var stateName = path.basename(subFile.path).replace(/(-state.js)$/, '');\r\n        module(mapper, dirPath, stateName, deep, dir + '\\\\');\r\n        futureState(mapper, dirPath, stateName, deep, dir + '\\\\');\r\n    });\r\n\r\n    stateMapper += (JSON.stringify(mapper) + '});');\r\n\r\n    stream.push(function () {\r\n        var file = new File();\r\n        file.path = mapperPath;\r\n        file.contents = new Buffer(stateMapper);\r\n        return file\r\n    }());\r\n}\r\n\r\n\r\nfunction module(mapper, directory, stateName, deep, appPath, baseDir) {\r\n    mapper.modules.push({\r\n        \"reconfig\": true,\r\n        \"name\": \"app.states.\" + (appPath + directory).replace(/\\\\/g, '.').replace(/-state$/, '') + \"\",\r\n        \"files\": [(deep ? deep + baseDir + '/js/' : '') + \"states/\" + directory]\r\n    });\r\n}\r\nfunction futureState(mapper, directory, stateName, deep, appPath, baseDir) {\r\n    mapper.futureStates.push({\r\n        \"module\": \"app.states.\" + (appPath + directory).replace(/\\\\/g, '.').replace(/-state$/, '') + \"\",\r\n        \"stateName\": \"states.\" + stateName + \"\",\r\n        \"url\": \"/\" + stateName + \"\",\r\n        \"type\": \"ocLazyLoad\"\r\n    });\r\n}\r\n"]}